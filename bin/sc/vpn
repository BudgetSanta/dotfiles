#!/usr/bin/env bash

set -e

VPN_CONFIGS="$HOME/.vpn"
INITIAL_QUERY="${@:-}"

exe-req "gum" "rg"

config=$(rg "(^#|^[ ]*$)" --invert-match < "$VPN_CONFIGS" \
        | gum filter \
            --placeholder "VPN Fuzzy Search" \
            --value="$INITIAL_QUERY" \
            --select-if-one)

config=${config//, /,}
env=$(echo "$config" | cut -d ',' -f1)
service=$(echo "$config" | cut -d ',' -f2)
type=$(echo "$config" | cut -d ',' -f3)
port=$(echo "$config" | cut -d ',' -f4)
aws_profile=$(echo "$config" | cut -d ',' -f5)

# Login to AWS SSO if not already logged in
aws sts get-caller-identity &> /dev/null ||aws sso login

pushd "$HOME/git/ed-infra-ssm-vpn" &>/dev/null || exit

service_type_suffix=$([[ $type =~ ^(primary|writer)$ ]] && echo "-$type" || echo "")
resource="$service$service_type_suffix"

export LOCAL_PORT="$port"; ./aws-connect.sh "$env" "$resource"

popd &>/dev/null || exit
